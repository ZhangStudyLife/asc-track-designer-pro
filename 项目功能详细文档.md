# ASC智能车赛道设计器 - 项目功能详细文档

**项目版本**: 2.0.0
**最后更新**: 2024年
**开发方**: ASC实验室
**应用名称**: ASC赛道设计器

---

## 📋 目录

1. [项目概述](#项目概述)
2. [核心功能系统](#核心功能系统)
3. [技术架构](#技术架构)
4. [部署和打包](#部署和打包)
5. [UI美化和交互](#ui美化和交互)
6. [数据存储和导出](#数据存储和导出)
7. [快捷键和操作](#快捷键和操作)
8. [系统配置](#系统配置)

---

## 🎯 项目概述

### 项目定位

ASC智能车赛道设计器是一个专业的赛道布局设计工具，专为ASC(自主服务车)智能车竞赛设计。这是一个**双模式应用**:

- **Web模式**: 可在浏览器中运行（通过Vercel自动部署）
- **桌面模式**: 独立的Windows应用（通过Electron打包）

### 主要特性

| 功能模块 | 描述 |
|---------|------|
| **拖拽设计** | 使用鼠标拖拽在16M×8M的标准竞赛场地内设计赛道 |
| **智能吸附** | 自动吸附连接相邻的赛道元件（吸附距离30px） |
| **距离测量** | 点击两个吸附点快速测量距离 |
| **自动补全** | 自动生成直道连接两个指定的连接点 |
| **物料清单** | 生成BOM(Bill of Materials)统计所有赛道元件 |
| **多格式导出** | 支持JSON、PNG等多种导出格式 |
| **缩放平移** | 流畅的视图缩放和拖拽平移 |
| **撤销重做** | Ctrl+Z撤销，最多保存100步历史 |
| **多选操作** | 支持框选、Ctrl+点击多选 |
| **项目存档** | 支持多个项目保存和切换 |
| **缩略图导航** | 小地图快速预览和导航整个设计区域 |
| **自定义尺寸** | 用户可以定义和保存自定义的赛道尺寸 |

---

## 🏗️ 核心功能系统

### 1. 赛道元件系统

#### 1.1 赛道类型

项目支持两种基本的赛道元件类型：

**直道 (Straight Track)**
```json
{
  "id": 1234567890,
  "type": "straight",
  "params": {
    "length": 50        // 长度，单位: cm
  },
  "x": 0,              // 起点X坐标
  "y": 0,              // 起点Y坐标
  "rotation": 0        // 旋转角度，单位: 度 (0-360)
}
```

**弯道 (Curved Track)**
```json
{
  "id": 1234567890,
  "type": "curve",
  "params": {
    "radius": 50,      // 圆心到赛道中心线的距离，单位: cm
    "angle": 90        // 圆心角，单位: 度 (0-360)
  },
  "x": 0,              // 圆心X坐标
  "y": 0,              // 圆心Y坐标
  "rotation": 0        // 旋转角度，单位: 度
}
```

#### 1.2 坐标系统

- **设计区域**: 16M × 8M (标准ASC竞赛场地)
- **像素转换**: 1cm = 2px
- **设计边界**: x范围 [-1600, 1600], y范围 [-800, 800]
- **画布范围**: 包含边距的范围 [-2000, 2000] × [-1000, 1000]
- **赛道宽度**: 45cm (固定，渲染为90px)

#### 1.3 连接点系统

每个赛道元件都有两个连接点（吸附点）:
- **绿色点**: 起始连接点
- **红色点**: 终止连接点

**连接点计算**:

对于直道:
```
起点: (piece.x, piece.y)
终点: (piece.x + length*cos(rotation°), piece.y + length*sin(rotation°))
```

对于弯道:
```
起点: (piece.x + radius*2*cos(rotation°), piece.y + radius*2*sin(rotation°))
终点: (piece.x + radius*2*cos(rotation° + angle°), piece.y + radius*2*sin(rotation° + angle°))
```

#### 1.4 吸附系统

- **吸附距离**: 30像素
- **吸附触发**: 当拖拽的赛道元件连接点与其他元件连接点距离 < 30px时触发
- **自动吸附**: 元件自动对齐到目标连接点
- **可视反馈**: 吸附时连接点高亮显示

### 2. 视图系统

#### 2.1 ViewBox管理

应用使用SVG的viewBox系统进行缩放和平移:

```javascript
viewBox = {
  x: -2000,        // 左上角X坐标
  y: -1000,        // 左上角Y坐标
  width: 4000,     // 可见宽度
  height: 2000     // 可见高度
}
```

#### 2.2 缩放范围

- **最小缩放**: 0.18倍 (显示整个16M×8M区域)
- **最大缩放**: 2.5倍 (细致编辑)
- **缩放因子**: 1.15倍 (每次滚轮)

#### 2.3 缩放操作

1. **鼠标滚轮**: Ctrl+滚轮进行缩放
   - 向上滚动: 放大 (乘以1.15)
   - 向下滚动: 缩小 (乘以0.85)
   - 以鼠标位置为中心缩放

2. **拖拽平移**:
   - 方式1: Ctrl+左键拖拽
   - 方式2: 右键拖拽
   - 方式3: 通过缩略图拖拽红框

#### 2.4 重置视图

- **快捷键**: Home键
- **功能**: 重置到初始视图 (完整显示16M×8M区域)
- **效果**: viewBox恢复到 {x: -2000, y: -1000, width: 4000, height: 2000}

### 3. 缩略图系统

#### 3.1 缩略图特性

- **显示位置**: 左侧面板顶部
- **尺寸**: 300×150像素
- **背景**: 浅灰色 (#f3f4f6)
- **用途**:
  - 显示整个设计区域
  - 可视化当前视口位置
  - 快速导航到指定位置

#### 3.2 缩略图渲染

- **直道**: 蓝色线段 (#6366f1)
- **弯道**: 橙色弧线 (#f59e42)
- **视口框**: 红色虚线矩形，可拖拽 (#ef4444)
- **线条宽度**: 4像素

#### 3.3 缩略图交互

拖拽红色矩形框:
1. 鼠标按下时记录点击位置和框位置的偏移
2. 拖拽过程中计算新位置
3. 边界限制: 确保框不超出缩略图边界
4. 实时更新主视图的viewBox

### 4. 历史管理系统

#### 4.1 撤销/重做

- **存储位置**: localStorage中的'piecesHistory'键
- **最大步数**: 100步
- **触发时机**:
  - 添加/删除元件
  - 拖拽元件完成
  - 旋转元件
  - 使用自动补全功能

#### 4.2 历史记录结构

```javascript
// localStorage['piecesHistory'] 是数组
[
  [piece1, piece2, ...],  // 状态1
  [piece1_modified, piece2, ...],  // 状态2
  ...
]
```

#### 4.3 撤销逻辑

```
按下Ctrl+Z
↓
弹出最后一个状态
↓
恢复pieces到倒数第二个状态
↓
显示"撤销成功"提示
```

### 5. 元件选择系统

#### 5.1 选择模式

**单选模式**:
- 点击元件: 选中该元件
- 显示边框: 所选元件有蓝色高亮边框

**多选模式**:
- Ctrl+点击: 添加/移除选择
- selectedIds数组保存多个选中的元件ID

**框选模式**:
- 空白区域点击并拖拽: 自动框选范围内的所有元件
- 检测: 元件中心点在选择框内即视为被选中

#### 5.2 选择状态

```javascript
selectedId: null | number           // 单个选中元件ID
selectedIds: number[]               // 多个选中元件的ID数组
isSelecting: boolean                // 是否正在框选
selectionBox: null | {x, y, width, height}  // 框选范围
```

### 6. 拖拽系统

#### 6.1 拖拽流程

1. **mouseDown**:
   - 记录拖拽开始状态
   - 计算鼠标与元件中心的偏移量
   - 记录历史快照

2. **mouseMove**:
   - 计算新位置
   - 检查吸附
   - 实时更新元件位置

3. **mouseUp**:
   - 最终确认位置
   - 结束拖拽状态

#### 6.2 吸附逻辑

```javascript
function findNearestConnectionPoint(draggedPiece, newX, newY) {
  // 计算拖拽元件的两个新连接点
  const draggedPoints = getConnectionPoints({...draggedPiece, x: newX, y: newY})

  // 遍历所有其他元件
  for (const otherPiece of pieces) {
    if (otherPiece.id === draggedPiece.id) continue
    const otherPoints = getConnectionPoints(otherPiece)

    // 检查所有点对组合
    for (const draggedPoint of draggedPoints) {
      for (const otherPoint of otherPoints) {
        const distance = Math.sqrt((draggedPoint.x - otherPoint.x)² + (draggedPoint.y - otherPoint.y)²)

        // 如果距离小于30px，则吸附
        if (distance < 30) {
          return {
            targetX: otherPoint.x - (draggedPoint.x - newX),
            targetY: otherPoint.y - (draggedPoint.y - newY),
            distance
          }
        }
      }
    }
  }

  return null
}
```

### 7. 旋转系统

#### 7.1 旋转操作

**方式1 - Tab键旋转**:
- 按Tab键: 所选元件旋转 -15°
- 每次按键: 旋转-15度

**方式2 - 双击精确输入**:
- 双击选中的元件: 弹出旋转输入框
- 输入精确的旋转角度 (0-360°)
- 按Enter或确认: 应用新角度

#### 7.2 旋转数据

```javascript
rotation: number  // 存储在每个piece对象中
// 值范围: 0-360度
// 计算: (piece.rotation || 0) % 360
```

### 8. 测量系统

#### 8.1 测量模式

**启动**: 点击"测量"按钮
- isMeasuring = true
- measurePoints = []

**操作**:
1. 点击第一个吸附点: measurePoints = [point1]
2. 点击第二个吸附点: measurePoints = [point1, point2]
3. 自动计算距离并显示

#### 8.2 距离计算

```javascript
// 显示的距离 = 欧几里得距离 / 2
// 因为 1cm = 2px
const distance = Math.sqrt((p1.x - p2.x)² + (p1.y - p2.y)²) / 2  // cm
```

### 9. 自动补全系统

#### 9.1 自动补全流程

**启动**: 点击"自动补全"按钮

**操作**:
1. 点击第一个吸附点（连接点1）
2. 点击第二个吸附点（连接点2）
3. 系统自动计算:
   - 两点间的距离
   - 两点间的角度
4. 自动生成连接直道:
   - 类型: straight
   - 参数: {length: distance/2}
   - 位置: 从点1开始
   - 旋转: 计算得出的角度

#### 9.2 实现代码流程

```javascript
const getPointCoord = (mp) => {
  // 根据连接点信息获取当前坐标
  const piece = pieces.find(p => p.id === mp.pieceId)

  if (piece.type === 'straight') {
    if (mp.type === 'start') {
      return {x: piece.x, y: piece.y}
    } else {
      const length = piece.params.length * 2
      return {
        x: piece.x + length * cos(rotation°),
        y: piece.y + length * sin(rotation°)
      }
    }
  } else if (piece.type === 'curve') {
    // 计算圆弧上的点...
  }
}

// 获取两个连接点坐标
const pt1 = getPointCoord(points[0])
const pt2 = getPointCoord(points[1])

// 计算距离和角度
const dx = pt2.x - pt1.x
const dy = pt2.y - pt1.y
const distance = Math.sqrt(dx² + dy²)
const angle = atan2(dy, dx) * 180 / π

// 创建新的直道元件
const newPiece = {
  id: Date.now(),
  type: 'straight',
  params: {length: distance / 2},
  x: pt1.x,
  y: pt1.y,
  rotation: angle
}
```

### 10. BOM(物料清单)系统

#### 10.1 BOM统计

**计算内容**:
- 每种赛道类型的数量
- 赛道总长度（米）
- 赛道总件数

#### 10.2 BOM格式

```javascript
{
  "bom": {
    "L50": 5,           // 50cm直道 5根
    "L100": 3,          // 100cm直道 3根
    "R50-90": 2,        // 半径50cm、90°弯道 2根
    "R100-180": 1       // 半径100cm、180°弯道 1根
  },
  "totalLength": "34.56",  // 总长度（米）
  "totalPieces": 11        // 总件数
}
```

#### 10.3 长度计算

**直道长度**: length (cm，直接使用)

**弯道长度**: radius × angle(°) × π / 180 (cm)

**总长度**: (所有长度求和) / 100 (转为米)

---

## 💻 技术架构

### 1. 开发模式架构

```
启动命令: npm run dev
            ↓
并行运行:
├─ Next.js Dev Server (localhost:3000)
│  └─ 监听代码变化自动热更新
│
└─ Electron + Renderer Process
   └─ 加载 http://localhost:3000
   └─ 显示在桌面窗口中
```

### 2. 生产模式架构

```
静态导出流程:
1. npm run build:web (Next.js构建成静态HTML/CSS/JS)
   └─ 输出到 out/ 目录
   └─ 包含所有资源文件

2. Electron主进程加载
   └─ 读取 out/index.html
   └─ 自定义协议处理ASAR资源
   └─ 显示完整应用

打包流程:
3. electron-builder 打包
   └─ 将 out/ 目录打包进ASAR存档
   └─ 加入 electron.js 主进程
   └─ 生成 .exe 安装包和便携版
```

### 3. 项目结构

```
asc-track-designer/
├── src/
│   └── app/
│       ├── page.tsx          # 主应用组件 (3180行，单体式)
│       ├── layout.tsx        # 根布局
│       └── globals.css       # 全局样式 (225行)
│
├── public/
│   ├── lab-logo.png          # ASC实验室标志
│   └── icon.ico              # 应用图标
│
├── electron.js               # Electron主进程 (89行)
│
├── 配置文件:
│   ├── package.json          # 项目配置 + electron-builder配置
│   ├── next.config.js        # Next.js配置
│   ├── tsconfig.json         # TypeScript配置
│   ├── tailwind.config.js    # Tailwind配置
│   ├── postcss.config.js     # PostCSS配置
│   └── vercel.json           # Vercel部署配置
│
├── 批处理脚本:
│   ├── 启动ASC赛道设计器.bat
│   ├── 打包成EXE.bat
│   ├── Web模式启动.bat
│   └── 清理项目.bat
│
└── 文档:
    ├── README.md
    ├── CLAUDE.md
    ├── DEPLOY.md
    └── 项目说明.md
```

### 4. 技术栈

| 类别 | 技术 | 版本 |
|------|------|------|
| **框架** | Next.js | 15.0.3 |
| **UI框架** | React | 18.3.1 |
| **桌面应用** | Electron | 28.3.3 |
| **类型检查** | TypeScript | 5.6.3 |
| **样式** | Tailwind CSS | 3.4.14 |
| **图形库** | SVG (原生) | - |
| **打包工具** | electron-builder | 25.1.8 |
| **并行运行** | concurrently | 9.1.0 |

### 5. 关键文件详解

#### 5.1 electron.js (89行)

**功能**:
- 创建Electron主窗口
- 处理开发模式 vs 生产模式的加载方式
- 注册自定义文件协议处理ASAR资源
- 管理应用生命周期

**关键点**:
```javascript
// 开发模式: 加载远程URL
if (isDev) {
  mainWindow.loadURL('http://localhost:3000')
}

// 生产模式: 加载本地HTML文件
else {
  const indexPath = path.join(__dirname, 'out', 'index.html')
  mainWindow.loadFile(indexPath)
}

// 注册自定义协议处理 /_next/ 和 /lab-logo.png
registerLocalResourceProtocol()
```

#### 5.2 page.tsx (3180行)

**结构**:
- 单个React函数组件
- 使用 "use client" 指令 (Next.js 13+ App Router)
- 使用React.createElement() 而非JSX
- 所有逻辑、UI、事件处理集中在一个文件

**主要功能块**:
1. 状态管理 (useState hooks)
2. 生命周期 (useEffect hooks)
3. 事件处理函数
4. 工具函数 (坐标转换、距离计算等)
5. UI渲染 (整个页面的HTML结构)

**状态变量** (100+个):
- pieces: 所有赛道元件
- viewBox: 当前视图范围
- selectedId/selectedIds: 选中的元件
- isDragging: 拖拽状态
- isMeasuring: 测量模式
- isAutoFill: 自动补全模式
- ... 等等

#### 5.3 next.config.js

**重要配置**:
```javascript
// 不使用 output: 'export' (允许Vercel动态部署)
reactStrictMode: true
images: { unoptimized: true }  // 禁用图片优化

// webpack配置: 排除服务器端的canvas和konva
webpack: (config, { isServer }) => {
  if (isServer) {
    config.externals = [...config.externals, 'canvas']
    config.resolve.alias['konva/lib/index-node'] = false
  }
  return config
}
```

#### 5.4 vercel.json

```json
{
  "buildCommand": "npm run build:web",    // 构建命令
  "outputDirectory": ".next",              // 输出目录
  "installCommand": "npm install --legacy-peer-deps",
  "framework": "nextjs",
  "build": {
    "env": {
      "NEXT_TELEMETRY_DISABLED": "1"      // 禁用遥测
    }
  },
  "cleanUrls": true,                      // 去掉.html
  "trailingSlash": false
}
```

---

## 🚀 部署和打包

### 1. Vercel自动部署

#### 1.1 部署流程

**连接GitHub**:
1. 登录 Vercel.com
2. 导入GitHub仓库
3. 选择 asc-track-designer 项目
4. 配置环境和构建设置

**自动部署**:
1. 每次推送到main分支时自动触发
2. Vercel运行: `npm run build:web`
3. 生成静态资源到 `.next` 目录
4. 自动部署到Vercel CDN

**访问地址**:
- 生成自动URL: https://[project].vercel.app
- 可配置自定义域名

#### 1.2 部署优化

**vercel.json配置**:
- buildCommand: 明确指定构建命令
- outputDirectory: 指定输出目录
- installCommand: 使用 --legacy-peer-deps 避免依赖冲突
- 禁用Next.js遥测收集

**性能优化**:
- 静态资源自动缓存
- 图片自动压缩
- CSS和JS自动minify
- CDN全球加速

### 2. Windows EXE打包

#### 2.1 打包命令

```bash
# 完整打包流程
npm run dist:win

# 等同于:
npm run build:electron && electron-builder --win --x64
```

#### 2.2 打包输出

**生成文件**:
- `ASC赛道设计器 Setup.exe` - NSIS安装程序
- `ASC赛道设计器.exe` - 便携版可执行文件

**文件大小**: 约100-150MB (经优化)

**输出位置**: `release/` 目录

#### 2.3 package.json中的打包配置

```json
"build": {
  "appId": "com.asc.trackdesigner",
  "productName": "ASC赛道设计器",
  "copyright": "Copyright © 2024 ASC实验室",
  "asar": true,                          // 启用ASAR压缩
  "icon": "public/icon.ico",

  "win": {
    "target": [
      {
        "target": "nsis",               // 安装程序
        "arch": ["x64"]
      },
      {
        "target": "portable",           // 便携版
        "arch": ["x64"]
      }
    ]
  },

  "nsis": {
    "oneClick": false,                  // 不一键安装
    "allowToChangeInstallationDirectory": true,  // 允许选择安装位置
    "perMachine": false,                // 当前用户安装
    "deleteAppDataOnUninstall": true,
    "createDesktopShortcut": true,      // 创建桌面快捷方式
    "createStartMenuShortcut": true,    // 创建开始菜单快捷方式
    "shortcutName": "ASC赛道设计器"
  }
}
```

### 3. 一键启动脚本

#### 3.1 启动ASC赛道设计器.bat

**功能**:
- 检查Node.js环境
- 自动安装依赖
- 启动Next.js + Electron开发服务器
- 开发模式下自动热更新

**执行步骤**:
```batch
@echo off
chcp 65001 >nul 2>&1              # 设置UTF-8编码
title ASC智能车赛道设计器
color 0A                          # 绿色文字

# 检查Node.js
node --version >nul 2>&1

# 安装依赖
if not exist node_modules (
    call npm install
)

# 启动应用
call npm run dev
```

#### 3.2 其他批处理脚本

**Web模式启动.bat**:
```
启动 Next.js 开发服务器
不使用 Electron 包装
访问 http://localhost:3000
```

**打包成EXE.bat**:
```
检查环境
清理旧构建
npm run build:web
npm run dist:win
自动打开 release 文件夹
```

**清理项目.bat**:
```
删除 node_modules (~9GB)
删除 .next、.vscode、.vercel 缓存
删除 release、out 目录
项目最终大小: 2-3MB
```

### 4. 完整部署工作流

```
开发流程:
1. 本地开发: npm run dev
   ↓
2. 测试应用: 在Electron窗口中测试
   ↓
3. 修改代码: 自动热更新
   ↓
提交和部署:
4. Git提交: git commit + git push main
   ↓
5. 触发Vercel部署: 自动构建和部署
   ↓
6. 生成Web版本: https://project.vercel.app
   ↓
打包桌面版:
7. 双击 打包成EXE.bat
   ↓
8. 生成 release/ASC赛道设计器.exe
   ↓
9. 分发EXE给用户
```

---

## 🎨 UI美化和交互

### 1. 全局样式系统

#### 1.1 globals.css (225行)

**设计理念**: 简化样式，不依赖Tailwind CSS的JIT编译

**样式内容**:
- 基础CSS类 (flex, flex-col, w-*, h-*, p-*, m-*, etc.)
- 按钮样式和悬停效果
- 输入框和范围滑块美化
- Flexbox布局工具类
- 暗黑模式支持

**主要类别**:
- 布局: `.flex`, `.flex-col`, `.flex-1`, `.items-center`, `.justify-between`
- 尺寸: `.w-full`, `.w-64`, `.w-20`, `.h-screen`
- 间距: `.p-2`, `.p-4`, `.mb-2`, `.mb-4`, `.space-y-2`, `.space-x-2`
- 颜色: `.bg-gray-50`, `.bg-white`, `.bg-blue-500`, `.bg-red-500`
- 文字: `.text-white`, `.text-gray-500`, `.font-semibold`, `.text-center`

#### 1.2 颜色系统

| 颜色 | 用途 | 十六进制 |
|------|------|---------|
| 白色 | 背景 | #ffffff |
| 灰色50 | 面板背景 | #f9fafb |
| 灰色300 | 边框/禁用 | #d1d5db |
| 蓝色500 | 主题/按钮 | #3b82f6 |
| 绿色500 | 正面操作 | #10b981 |
| 红色500 | 删除/错误 | #ef4444 |
| 橙色500 | 警告/强调 | #f97316 |

### 2. 应用布局结构

```
┌─────────────────────────────────────────┐
│         顶部导航栏 (Header)             │
│  [Logo] [标题] [状态消息]               │
├────────────────┬───────────────────────┤
│                │                       │
│  左侧面板      │    主画布区域         │
│  (Sidebar)     │    (Canvas)           │
│                │                       │
│  - 缩略图      │  - 赛道元件展示      │
│  - 功能按钮    │  - 网格背景          │
│  - 赛道尺寸    │  - 选择框            │
│  - 操作面板    │  - 测量线            │
│                │                       │
└────────────────┴───────────────────────┘
```

### 3. UI组件详解

#### 3.1 顶部导航栏

**元素**:
- ASC实验室Logo (左侧)
- 应用标题: "智能车赛道绘制系统"
- 状态消息显示区域 (右侧，临时提示)
- 当前项目名称

**样式**:
- 背景色: 白色
- 边框: 下边框
- 高度: 60px
- 字体: 系统字体

#### 3.2 左侧面板

**宽度**: 256px (w-64)

**分区**:

1. **缩略图区域** (顶部)
   - SVG缩略图显示
   - 红色虚线矩形表示视口
   - 可拖拽导航

2. **功能按钮区** (中上)
   - 测量按钮 (Toggle)
   - 自动补全按钮 (Toggle)
   - 其他快速操作

3. **赛道尺寸区** (中下)
   - 标签: 直道尺寸、弯道尺寸
   - 固定尺寸按钮集合
   - 自定义尺寸按钮

4. **操作面板** (下部)
   - 新建项目
   - 保存/加载存档
   - 导入/导出JSON
   - 导出PNG图片
   - 显示BOM

#### 3.3 主画布区域

**尺寸**:
- 宽度: 100% - 256px (自适应)
- 高度: 100vh - 60px (自适应)

**背景**:
- 白色背景
- 网格图案 (可选)

**交互元素**:
- SVG元素: 赛道、选择框、测量线
- 鼠标事件: 拖拽、缩放、选择

### 4. 交互设计

#### 4.1 鼠标交互

| 操作 | 效果 |
|------|------|
| 左键点击元件 | 选中/取消选中 |
| Ctrl+左键点击 | 多选/取消多选 |
| 左键拖拽元件 | 移动元件（自动吸附） |
| 左键拖拽空白 | 框选多个元件 |
| Ctrl+拖拽空白 | 平移画布 |
| 右键拖拽空白 | 平移画布 |
| Ctrl+滚轮 | 缩放视图 |
| 双击元件 | 输入旋转角度 |
| 鼠标悬停元件 | 显示连接点 |

#### 4.2 键盘快捷键

| 快捷键 | 功能 |
|--------|------|
| Tab | 旋转选中元件 -15° |
| Delete | 删除选中元件 |
| Escape | 取消选择/模式 |
| Ctrl+A | 全选所有元件 |
| Ctrl+Z | 撤销 |
| Ctrl+S | 保存/存档当前项目 |
| Ctrl+O | 打开/导入JSON |
| Ctrl+E | 导出为PNG |
| Home | 重置视图到初始位置 |
| Ctrl+F | 适应屏幕 (如果实现) |
| Ctrl+G | 聚焦选中元件 (如果实现) |

### 5. 对话框和弹窗

#### 5.1 存档对话框

**触发**: 点击"保存"按钮或Ctrl+S

**内容**:
- 输入框: 存档名称
- 确认按钮: "保存"
- 取消按钮: "取消"

**行为**:
- 保存当前pieces、viewBox、时间戳
- 存储到localStorage
- 更新存档列表

#### 5.2 自定义尺寸对话框

**触发**: 点击"添加自定义尺寸"

**直道模式**:
- 输入框: 长度 (cm)
- 按钮: 添加

**弯道模式**:
- 输入框1: 半径 (cm)
- 输入框2: 角度 (°)
- 按钮: 添加

**行为**:
- 验证输入
- 保存到localStorage
- 更新可用尺寸列表

#### 5.3 BOM对话框

**触发**: 点击"显示BOM"

**内容**:
- 总元件数量
- 赛道总长度 (米)
- 详细元件统计表格

### 6. 响应式设计

**断点处理**:
- 桌面版: 全功能UI
- 平板版: 左侧面板可折叠
- 手机版: 完全隐藏左侧面板

**自适应元素**:
- 画布宽度自动调整
- 按钮大小自适应屏幕
- 文字大小响应式缩放

### 7. 可视化反馈

#### 7.1 选中状态

```css
/* 被选中的元件 */
stroke: #3b82f6;        /* 蓝色 */
stroke-width: 3;
```

#### 7.2 吸附状态

```css
/* 参与吸附的连接点 */
fill: #fbbf24;          /* 黄色高亮 */
r: 6;                   /* 半径加大 */
```

#### 7.3 悬停状态

```css
/* 元件悬停时 */
opacity: 0.8;
```

---

## 💾 数据存储和导出

### 1. localStorage 存储系统

#### 1.1 存储键值

| 键名 | 内容 | 类型 | 说明 |
|------|------|------|------|
| `piecesHistory` | 操作历史 | Array | 最多100个状态快照 |
| `trackSizes` | 自定义尺寸 | Object | {straights: [], curves: []} |
| `hiddenFixedSizes` | 隐藏的固定尺寸 | Object | 同上格式 |
| `trackArchives` | 存档名称列表 | Array | 所有保存的项目名称 |
| `archive_${name}` | 项目数据 | Object | 单个项目的完整数据 |
| `currentTrackProject` | 当前项目 | Object | 自动保存的工作区 |

#### 1.2 存储结构

**piecesHistory**:
```json
[
  [{piece1}, {piece2}, ...],      // 状态1
  [{piece1_modified}, {piece2}],  // 状态2
  ...
]
```

**trackSizes**:
```json
{
  "straights": [50, 75, 100, 150, 200],
  "curves": [
    {radius: 50, angle: 30},
    {radius: 50, angle: 45},
    {radius: 100, angle: 90}
  ]
}
```

**archive_${name}**:
```json
{
  "name": "项目名称",
  "pieces": [...],
  "viewBox": {x: -2000, y: -1000, width: 4000, height: 2000},
  "timestamp": "2024-01-01T12:00:00Z"
}
```

### 2. JSON导出/导入

#### 2.1 导出格式

**标准格式**:
```json
{
  "version": "1.0",
  "created": "2024-01-01T12:00:00Z",
  "bounds": {
    "width": 3200,
    "height": 1600,
    "x": -1600,
    "y": -800
  },
  "pieces": [
    {
      "id": 1234567890,
      "type": "straight",
      "params": {length: 50},
      "x": 100,
      "y": 200,
      "rotation": 45
    },
    ...
  ]
}
```

**BOM信息格式**:
```json
{
  "totalPieces": 25,
  "totalLength": "45.67",
  "pieces": ["L50", "L100", "R50-90"],
  "bom": {
    "L50": 5,
    "L100": 3,
    "R50-90": 2
  },
  "details": [
    {
      "type": "straight",
      "params": {length: 50},
      "position": {x: 100, y: 200},
      "rotation": 45
    },
    ...
  ]
}
```

#### 2.2 导入兼容性

系统支持多种JSON格式的自动识别:

```javascript
// 优先级1: 完整信息格式 (有totalPieces和details)
if (trackData.totalPieces && trackData.details) { ... }

// 优先级2: 标准格式 (有pieces)
else if (trackData.pieces) { ... }

// 优先级3: 简单details格式
else if (trackData.details) { ... }

// 优先级4: 直接数组格式
else if (Array.isArray(trackData)) { ... }
```

### 3. PNG图片导出

#### 3.1 导出参数

- **分辨率**: 9600×3840 像素 (超高分辨率)
- **尺寸比例**: 16:8 (对应16M×8M)
- **格式**: PNG (无损压缩)
- **质量**: 最高

#### 3.2 导出内容

**左侧**:
- 完整的赛道设计图
- SVG渲染的所有元件
- 白色背景

**右侧**:
- BOM物料清单标题
- 总元件数量
- 赛道总长度
- 详细的元件统计表格
  - 元件类型 (黄色)
  - 数量 (绿色)
  - 交替背景色 (深灰/浅灰)

#### 3.3 导出流程

```javascript
function exportAsImage() {
  const svg = svgRef.current

  // 创建临时SVG (设置完整的viewBox)
  const tempSvg = svg.cloneNode(true)
  tempSvg.setAttribute('viewBox', `${DESIGN_BOUNDS.x} ${DESIGN_BOUNDS.y} ${DESIGN_BOUNDS.width} ${DESIGN_BOUNDS.height}`)

  // 转换为PNG
  const canvas = document.createElement('canvas')
  const ctx = canvas.getContext('2d')
  canvas.width = 9600
  canvas.height = 3840

  // SVG → Canvas
  const img = new Image()
  img.onload = () => {
    ctx.drawImage(img, 0, 0, 7680, 3840)

    // 绘制BOM信息到右侧
    drawBOMInfo(ctx)

    // Canvas → PNG文件
    canvas.toBlob((blob) => {
      downloadFile(blob, `track_design_${timestamp}.png`)
    })
  }
}
```

---

## ⌨️ 快捷键和操作

### 1. 快捷键大全

#### 1.1 编辑快捷键

| 快捷键 | 功能 | 说明 |
|--------|------|------|
| **Ctrl+Z** | 撤销 | 回退到上一个状态 |
| **Ctrl+A** | 全选 | 选中所有赛道元件 |
| **Delete** | 删除 | 删除选中的元件 |
| **Escape** | 取消 | 取消选择/操作/输入 |

#### 1.2 文件快捷键

| 快捷键 | 功能 | 说明 |
|--------|------|------|
| **Ctrl+S** | 保存 | 打开存档对话框 |
| **Ctrl+O** | 打开 | 打开文件选择器导入JSON |
| **Ctrl+E** | 导出图片 | 导出为高分辨率PNG |

#### 1.3 视图快捷键

| 快捷键 | 功能 | 说明 |
|--------|------|------|
| **Home** | 重置视图 | 回到初始缩放和位置 |
| **Ctrl+滚轮** | 缩放 | 向上放大, 向下缩小 |

#### 1.4 元件操作

| 快捷键 | 功能 | 说明 |
|--------|------|------|
| **Tab** | 旋转 | 选中元件旋转 -15° |
| **双击** | 精确旋转 | 输入具体旋转角度 |

### 2. 鼠标操作详解

#### 2.1 选择操作

```
单选:     点击元件
多选:     Ctrl + 点击多个元件
反选:     Ctrl + 已选元件 (取消选择)
框选:     拖拽空白区域 (按住左键)
全选:     Ctrl + A
```

#### 2.2 移动操作

```
拖拽移动:  点击元件 + 拖动
        （自动吸附相邻元件)

平移画布:  Ctrl + 拖动空白
        或 右键 + 拖动空白
```

#### 2.3 缩放操作

```
放大:      Ctrl + 鼠标向上滚动
        或 缩略图拖拽红框向下

缩小:      Ctrl + 鼠标向下滚动
        或 缩略图拖拽红框向上

重置:      按下 Home 键
```

#### 2.4 测量操作

```
1. 点击 "测量" 按钮
2. 点击第一个连接点 (绿色或红色)
3. 点击第二个连接点
4. 距离自动计算显示
5. 点击 "清除" 或重新点击 "测量" 取消
```

#### 2.5 自动补全操作

```
1. 点击 "自动补全" 按钮
2. 点击第一个连接点
3. 点击第二个连接点
4. 系统自动生成连接直道
```

### 3. 按钮功能

#### 3.1 顶部按钮组

- **新建**: 新建空白项目
- **打开**: 从localStorage加载存档
- **保存**: 保存当前项目为存档
- **导入**: 从JSON文件导入
- **导出**: 导出为JSON文件
- **图片**: 导出为PNG图片
- **BOM**: 显示物料清单

#### 3.2 左侧按钮组

- **测量**: 开启测量模式
- **补全**: 开启自动补全模式
- **新尺寸**: 打开自定义尺寸对话框
- **重置视图**: 回到初始显示位置

#### 3.3 赛道尺寸按钮

**直道按钮**:
- L25、L50、L75、L100、L150、L200 (cm)

**弯道按钮**:
- R50-30、R50-45、R50-60、R50-90 (半径-角度)
- R100-30、R100-45、R100-60、R100-90、R100-180

---

## ⚙️ 系统配置

### 1. package.json配置详解

#### 1.1 基本信息

```json
{
  "name": "asc-track-designer",
  "version": "2.0.0",
  "description": "ASC实验室智能车赛道设计器 - 专业的赛道布局设计工具",
  "main": "electron.js",
  "author": "ASC实验室"
}
```

#### 1.2 npm脚本

```json
"scripts": {
  "dev": "并行运行 Next.js dev + Electron",
  "build": "next build",
  "build:web": "next build (用于Web部署)",
  "build:electron": "next build (用于Electron)",
  "start:next": "next start",
  "dist:win": "npm run build:electron && electron-builder --win --x64",
  "clean": "rimraf .next out release node_modules",
  "reinstall": "npm run clean && npm install"
}
```

#### 1.3 依赖管理

**devDependencies**:
- next、react、react-dom: 核心框架
- electron、electron-builder: 桌面应用
- typescript: 类型检查
- tailwindcss、postcss: 样式处理
- konva、react-konva: 图形库 (虽然项目未使用)

### 2. TypeScript配置

#### 2.1 tsconfig.json

```json
{
  "compilerOptions": {
    "strict": false,              // 非严格模式
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]            // 路径别名
    }
  }
}
```

#### 2.2 类型定义

**src/types/jsx.d.ts**:
```typescript
// JSX命名空间声明
// 使React.createElement()能正常工作
```

### 3. Next.js配置

#### 3.1 next.config.js

```javascript
const nextConfig = {
  reactStrictMode: true,
  images: {
    unoptimized: true            // 禁用图片优化
  },
  eslint: {
    ignoreDuringBuilds: true     // 构建时忽略ESLint
  },
  webpack: (config, { isServer }) => {
    if (isServer) {
      config.externals = [...config.externals, 'canvas']
    }
    return config
  }
}
```

### 4. Electron配置

#### 4.1 打包配置 (package.json中)

```json
"build": {
  "appId": "com.asc.trackdesigner",
  "productName": "ASC赛道设计器",
  "asar": true,
  "icon": "public/icon.ico",

  "win": {
    "target": ["nsis", "portable"],
    "icon": "public/icon.ico"
  },

  "nsis": {
    "oneClick": false,
    "allowToChangeInstallationDirectory": true,
    "createDesktopShortcut": true,
    "createStartMenuShortcut": true
  }
}
```

#### 4.2 主进程配置 (electron.js)

```javascript
// 开发/生产模式检测
const isDev = !app.isPackaged

// 开发: 连接到localhost:3000
if (isDev) {
  mainWindow.loadURL('http://localhost:3000')
}

// 生产: 加载本地HTML
else {
  mainWindow.loadFile(path.join(__dirname, 'out', 'index.html'))
}
```

### 5. Vercel配置

#### 5.1 vercel.json

```json
{
  "buildCommand": "npm run build:web",
  "outputDirectory": ".next",
  "installCommand": "npm install --legacy-peer-deps",
  "framework": "nextjs",
  "cleanUrls": true
}
```

### 6. 性能参数

#### 6.1 优化设置

| 参数 | 值 | 说明 |
|------|-----|------|
| 缓存步数 | 100 | localStorage历史记录数 |
| 吸附距离 | 30px | 元件自动吸附触发距离 |
| 缩放倍率 | 1.15 | 每次滚轮缩放倍数 |
| 最小缩放 | 0.18x | 最小允许缩放比例 |
| 最大缩放 | 2.5x | 最大允许缩放比例 |
| 自动保存 | 5秒 | 自动保存延迟 |

#### 6.2 常量定义

```javascript
// 设计区域
const DESIGN_BOUNDS = {
  width: 3200,    // 16M = 3200px (1cm=2px)
  height: 1600,   // 8M = 1600px
  x: -1600,       // 中心在原点
  y: -800
}

// 吸附距离
const SNAP_DISTANCE = 30

// 赛道宽度
const TRACK_WIDTH = 90  // px (45cm = 90px)
```

---

## 📝 功能汇总

### 核心功能清单

- ✅ 拖拽式赛道设计
- ✅ 智能吸附连接
- ✅ 距离测量
- ✅ 自动补全直道
- ✅ BOM物料清单生成
- ✅ JSON导出/导入
- ✅ 高分辨率PNG导出
- ✅ 撤销功能 (100步历史)
- ✅ 多选和框选
- ✅ 项目存档管理
- ✅ 缩略图导航
- ✅ 自定义赛道尺寸
- ✅ 完整键盘快捷键
- ✅ 流畅的缩放平移
- ✅ localStorage数据持久化

### 部署和打包

- ✅ Vercel自动Web部署
- ✅ Windows EXE一键打包
- ✅ 两种安装方式 (NSIS安装程序 + 便携版)
- ✅ 批处理脚本快速操作
- ✅ 项目快速清理工具

### UI美化

- ✅ 现代化的扁平设计
- ✅ 响应式布局
- ✅ 暗黑模式支持
- ✅ 流畅的交互反馈
- ✅ 彩色的可视化提示
- ✅ 易用的对话框和菜单

---

## 📞 开发者参考

### 关键文件速查

| 文件 | 行数 | 功能 |
|------|------|------|
| `src/app/page.tsx` | 3180 | 核心应用逻辑 |
| `src/app/globals.css` | 225 | 全局样式 |
| `electron.js` | 89 | Electron主进程 |
| `package.json` | 103 | 项目配置 |
| `next.config.js` | 37 | Next.js配置 |
| `vercel.json` | 17 | Vercel部署配置 |

### 常见任务

**添加新的赛道尺寸**:
1. 修改 fixedSizes 数组
2. 添加按钮
3. 在 addPiece() 中处理

**修改UI样式**:
1. 编辑 globals.css
2. 或修改 page.tsx 中的 style 属性

**改变设计区域大小**:
1. 修改 DESIGN_BOUNDS 常量
2. 修改 CANVAS_BOUNDS 常量
3. 更新缩略图边界

**优化性能**:
1. 减少 pieces 数量
2. 优化渲染逻辑
3. 使用 React.memo 包装组件

---

## 📌 总结

ASC智能车赛道设计器是一个功能完整、结构清晰的专业工具。它展示了如何构建一个支持多平台部署的现代应用：

- **前端技术**: React + Next.js 15 (最新)
- **桌面支持**: Electron 28
- **部署方案**: Vercel (Web) + electron-builder (EXE)
- **用户体验**: 流畅的交互、丰富的功能、完整的文档

该项目是学习现代Web应用开发、Electron桌面应用、以及多平台部署的极佳参考。

---

**文档版本**: 1.0
**更新日期**: 2024年10月
**维护者**: ASC实验室
